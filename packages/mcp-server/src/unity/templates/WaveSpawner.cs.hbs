using UnityEngine;
using UnityEngine.Events;
using System.Collections;
using System.Collections.Generic;

/// <summary>
/// Manages wave-based enemy spawning
/// </summary>
public class WaveSpawner : MonoBehaviour
{
    [System.Serializable]
    public class Wave
    {
        public int enemyCount;
        public float spawnInterval;
        public float difficultyScale;
    }

    [Header("Wave Settings")]
    [SerializeField] private int wavesPerLevel = 3;
    [SerializeField] private float timeBetweenWaves = 5f;
    [SerializeField] private int baseEnemiesPerWave = 5;
    [SerializeField] private float enemyScalePerWave = 1.5f;

    [Header("Enemy Prefabs")]
    [SerializeField] private GameObject[] enemyPrefabs;

    [Header("Current State")]
    private int currentWave = 0;
    private int enemiesRemaining = 0;
    private bool spawning = false;
    private float currentDifficulty = 1f;

    [Header("Events")]
    public UnityEvent<int> OnWaveStart;
    public UnityEvent<int> OnWaveComplete;
    public UnityEvent OnAllWavesComplete;

    [Header("References")]
    private SpawnPoint[] spawnPoints;
    private LevelManager levelManager;

    private void Awake()
    {
        spawnPoints = FindObjectsOfType<SpawnPoint>();
        levelManager = GetComponent<LevelManager>();

        if (spawnPoints.Length == 0)
        {
            Debug.LogError("WaveSpawner: No spawn points found in scene!");
        }
    }

    public void StartWaves(int level, float difficulty)
    {
        currentWave = 0;
        currentDifficulty = difficulty;
        spawning = true;

        StartCoroutine(SpawnWaves());
    }

    private IEnumerator SpawnWaves()
    {
        while (currentWave < wavesPerLevel && spawning)
        {
            currentWave++;
            yield return StartCoroutine(SpawnWave());

            // Wait for all enemies to be defeated
            while (enemiesRemaining > 0)
            {
                yield return new WaitForSeconds(0.5f);
            }

            OnWaveComplete?.Invoke(currentWave);

            // Wait before next wave
            if (currentWave < wavesPerLevel)
            {
                yield return new WaitForSeconds(timeBetweenWaves);
            }
        }

        // All waves complete
        OnAllWavesComplete?.Invoke();
        if (levelManager != null)
        {
            levelManager.OnAllWavesComplete();
        }
    }

    private IEnumerator SpawnWave()
    {
        OnWaveStart?.Invoke(currentWave);

        // Calculate enemies for this wave
        int enemiesToSpawn = Mathf.RoundToInt(baseEnemiesPerWave * Mathf.Pow(enemyScalePerWave, currentWave - 1) * currentDifficulty);
        enemiesRemaining = enemiesToSpawn;

        float spawnInterval = 1.5f / currentDifficulty; // Faster spawning at higher difficulty

        // Spawn enemies
        for (int i = 0; i < enemiesToSpawn; i++)
        {
            if (!spawning) break;

            SpawnEnemy();
            yield return new WaitForSeconds(spawnInterval);
        }
    }

    private void SpawnEnemy()
    {
        if (enemyPrefabs == null || enemyPrefabs.Length == 0)
        {
            Debug.LogWarning("WaveSpawner: No enemy prefabs assigned!");
            return;
        }

        if (spawnPoints.Length == 0)
        {
            Debug.LogError("WaveSpawner: No spawn points available!");
            return;
        }

        // Select random enemy type and spawn point
        GameObject enemyPrefab = enemyPrefabs[Random.Range(0, enemyPrefabs.Length)];
        SpawnPoint spawnPoint = spawnPoints[Random.Range(0, spawnPoints.Length)];

        // Spawn enemy
        GameObject enemy = Instantiate(enemyPrefab, spawnPoint.GetSpawnPosition(), Quaternion.identity);

        // Subscribe to enemy death
        EnemyHealth enemyHealth = enemy.GetComponent<EnemyHealth>();
        if (enemyHealth != null)
        {
            enemyHealth.OnDeath.AddListener(OnEnemyDefeated);
        }
    }

    private void OnEnemyDefeated()
    {
        enemiesRemaining--;
        enemiesRemaining = Mathf.Max(0, enemiesRemaining);
    }

    public void StopSpawning()
    {
        spawning = false;
        StopAllCoroutines();
    }

    public int GetCurrentWave() => currentWave;
    public int GetEnemiesRemaining() => enemiesRemaining;
}
